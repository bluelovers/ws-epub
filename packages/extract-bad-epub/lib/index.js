"use strict";
/**
 * Created by user on 2019/7/10.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const JSZip = require("jszip");
const Bluebird = require("bluebird");
const fs_iconv_1 = require("fs-iconv");
const iconv_jschardet_1 = require("iconv-jschardet");
const jsdom_extra_1 = require("jsdom-extra");
const upath2_1 = require("upath2");
const mdconf2_1 = require("mdconf2");
const debug_color2_1 = require("debug-color2");
const execall2_1 = require("execall2");
const lodash_1 = require("lodash");
const jquery_1 = require("@node-novel/epub-util/lib/extract/jquery");
const html_1 = require("@node-novel/epub-util/lib/extract/html");
const text_1 = require("@node-novel/epub-util/lib/extract/text");
exports.console = new debug_color2_1.Console(null, {
    enabled: true,
    inspectOptions: {
        colors: true,
    },
    chalkOptions: {
        enabled: true,
    },
});
exports.console.enabledColor = true;
function autoExtract(srcFile, setting) {
    return load(srcFile)
        .tap(async (data) => {
        const cwd = setting && setting.cwd || upath2_1.default.join(process.cwd(), fixFilename(upath2_1.default.basename(srcFile)));
        let options = {
            ...data,
            cwd,
        };
        exports.console.dir({
            srcFile,
            cwd,
        });
        return Bluebird.all([
            saveTxt(options),
            saveAttach(options)
        ]);
    });
}
exports.autoExtract = autoExtract;
exports.default = autoExtract;
function fixFilename(file) {
    return fs_iconv_1.trimFilename(decodeURIComponent(file));
}
exports.fixFilename = fixFilename;
function buffer(buf, cache = {}) {
    return Bluebird.resolve(JSZip.loadAsync(buf, {
        decodeFileName(bytes) {
            return decodeURIComponent(iconv_jschardet_1.decode(bytes));
        },
    }))
        .then(async (zip) => {
        let txts = await files(zip.file(/\.(?:xhtml|html?)$/), cache);
        return Bluebird.props({
            zip,
            txts,
            files: zip.files,
            cache,
        });
    });
}
exports.buffer = buffer;
function files(files, cache = {}) {
    if (cache._attach == null) {
        cache._attach = {};
    }
    return Bluebird.resolve(files)
        .map(async (file, index) => {
        let buf = await file.async("nodebuffer")
            .then(iconv_jschardet_1.decode)
            .then(buf => {
            return html_1.fixHtml2(buf.toString());
        });
        let jsdom = await jsdom_extra_1.asyncJSDOM(buf);
        let { $, document } = jsdom;
        jquery_1.default($('body'), $);
        $('body').html(function (i, old) {
            return html_1.fixHtml2(old);
        });
        let title = document.title;
        let _parse = upath2_1.default.parse(file.name);
        let _id = fixFilename(_parse.name).replace(/[^\w_\-]+/g, '').slice(0, 20);
        // @ts-ignore
        cache._attach[_parse.dir] = cache._attach[_parse.dir] || {};
        cache._attach[_parse.dir].images = cache._attach[_parse.dir].images || {};
        let imgs = {};
        $('img').each((i, elem) => {
            let _this = $(elem);
            let src = (_this.attr('src') || '').trim();
            if (src) {
                let _name = _id + i.toString().padStart(3, '0');
                while (cache._attach[_parse.dir].images[_name] != null) {
                    _name = _id + (++i).toString().padStart(3, '0');
                }
                src = decodeURIComponent(src);
                imgs[_name] = src;
                cache._attach[_parse.dir].images[_name] = src;
                _this.after(`\n(圖片${_name})\n`);
                _this.remove();
            }
        });
        let innerText = text_1.default($(document.body).text());
        return {
            index,
            name: file.name,
            isDir: file.dir,
            title,
            innerText,
            imgs,
        };
    });
}
exports.files = files;
function saveAttach(options) {
    return Bluebird.resolve(Object.entries(options.cache._attach))
        .map(async ([dir, data]) => {
        let cwd = upath2_1.default.join(options.cwd, dir);
        data = lodash_1.cloneDeep(data);
        await Bluebird
            .resolve(Object.entries(data.images))
            .map(async ([id, src], index, length) => {
            let _parse = upath2_1.default.parse(src);
            let _src = upath2_1.default.join(_parse.dir, id + _parse.ext);
            let _img = upath2_1.default.join(dir, src);
            let _img_path = upath2_1.default.join(cwd, _src);
            data.images[id] = _src;
            return Bluebird
                .resolve(options.zip.file(_img))
                .then(v => v.async('nodebuffer'))
                .then(buf => {
                exports.console.gray(`[img][${padNum(index)}/${padNum(length)}]`, _img_path);
                return fs_iconv_1.outputFile(_img_path, buf);
            })
                .catch(e => {
                exports.console.error(e.message, {
                    dir,
                    name: src,
                    _img,
                });
            });
        });
        return fs_iconv_1.outputFile(upath2_1.default.join(cwd, 'ATTACH.md'), mdconf2_1.stringify({
            attach: data,
        }));
    });
}
exports.saveAttach = saveAttach;
function load(file, cache = {}) {
    return Bluebird.resolve(fs_iconv_1.readFile(file)).then(buf => buffer(buf, cache));
}
exports.load = load;
function padNum(n) {
    return n.toString().padStart(3, '0');
}
exports.padNum = padNum;
function saveTxt(options) {
    return Bluebird
        .resolve(options.txts)
        .map(async (file, index, length) => {
        let _parse = upath2_1.default.parse(file.name);
        let filename = upath2_1.default.join(options.cwd, _parse.dir, _parse.name + '_' + fixFilename(file.title) + '.txt');
        exports.console.gray.log(`[txt][${padNum(index)}/${padNum(length)}]`, filename);
        await fs_iconv_1.outputFile(filename, file.innerText);
        return filename;
    });
}
exports.saveTxt = saveTxt;
function isBadName(input) {
    return /index|^img$|\d{10,}/i.test(input) || isEncodeURI(input) || isHashedLike(input);
}
exports.isBadName = isBadName;
function isHashedLike(input, maxCount = 3) {
    let r = execall2_1.default(/([a-f][0-9]|[0-9][a-f])/ig, input);
    return r.length >= maxCount;
}
exports.isHashedLike = isHashedLike;
function isEncodeURI(input, maxCount = 3) {
    let r = execall2_1.default(/(%[0-9a-f]{2,})/ig, input);
    return r.length >= maxCount;
}
exports.isEncodeURI = isEncodeURI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsK0JBQWdDO0FBQ2hDLHFDQUFzQztBQUN0Qyx1Q0FBOEQ7QUFDOUQscURBQXlFO0FBRXpFLDZDQUFxRTtBQUVyRSxtQ0FBMEI7QUFDMUIscUNBQW9DO0FBQ3BDLCtDQUF1QztBQUN2Qyx1Q0FBK0I7QUFDL0IsbUNBQW1DO0FBQ25DLHFFQUFpRTtBQUNqRSxpRUFBMkU7QUFDM0UsaUVBQTZEO0FBRWhELFFBQUEsT0FBTyxHQUFHLElBQUksc0JBQU8sQ0FBQyxJQUFJLEVBQUU7SUFDeEMsT0FBTyxFQUFFLElBQUk7SUFDYixjQUFjLEVBQUU7UUFDZixNQUFNLEVBQUUsSUFBSTtLQUNaO0lBQ0QsWUFBWSxFQUFFO1FBQ2IsT0FBTyxFQUFFLElBQUk7S0FDYjtDQUNELENBQUMsQ0FBQztBQUVILGVBQU8sQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO0FBa0M1QixTQUFnQixXQUFXLENBQUMsT0FBZSxFQUFFLE9BRTVDO0lBRUEsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO1NBQ2xCLEdBQUcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUU7UUFFbkIsTUFBTSxHQUFHLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxHQUFHLElBQUksZ0JBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLFdBQVcsQ0FBQyxnQkFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFcEcsSUFBSSxPQUFPLEdBQUc7WUFDYixHQUFHLElBQUk7WUFDUCxHQUFHO1NBQ0gsQ0FBQztRQUVGLGVBQU8sQ0FBQyxHQUFHLENBQUM7WUFDWCxPQUFPO1lBQ1AsR0FBRztTQUNILENBQUMsQ0FBQztRQUVILE9BQU8sUUFBUSxDQUFDLEdBQUcsQ0FBQztZQUNuQixPQUFPLENBQUMsT0FB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QVcsQ0FBQyxLQUFLLENBQUMsSUFBSSxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUE7QUFDdkYsQ0FBQztBQUhELDhCQUdDO0FBRUQsU0FBZ0IsWUFBWSxDQUFDLEtBQWEsRUFBRSxXQUFtQixDQUFDO0lBRS9ELElBQUksQ0FBQyxHQUFHLGtCQUFPLENBQUMsMkJBQTJCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFcEQsT0FBTyxDQUFDLENBQUMsTUFBTSxJQUFJLFFBQVEsQ0FBQztBQUM3QixDQUFDO0FBTEQsb0NBS0M7QUFFRCxTQUFnQixXQUFXLENBQUMsS0FBYSxFQUFFLFdBQW1CLENBQUM7SUFFOUQsSUFBSSxDQUFDLEdBQUcsa0JBQU8sQ0FBQyxtQkFBbUIsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUU1QyxPQUFPLENBQUMsQ0FBQyxNQUFNLElBQUksUUFBUSxDQUFDO0FBQzdCLENBQUM7QUFMRCxrQ0FLQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTkvNy8xMC5cbiAqL1xuXG5pbXBvcnQgSlNaaXAgPSByZXF1aXJlKCdqc3ppcCcpO1xuaW1wb3J0IEJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmltcG9ydCB7IG91dHB1dEZpbGUsIHJlYWRGaWxlLCB0cmltRmlsZW5hbWUgfSBmcm9tICdmcy1pY29udic7XG5pbXBvcnQgeyBCdWZmZXJGcm9tLCBkZWNvZGUsIEVOVU1fTk9ERV9FTkNPRElORyB9IGZyb20gJ2ljb252LWpzY2hhcmRldCc7XG5pbXBvcnQgbWljcm9tYXRjaCA9IHJlcXVpcmUoJ21pY3JvbWF0Y2gnKTtcbmltcG9ydCB7IEpTRE9NLCBjcmVhdGVKU0RPTSwgSUpTRE9NLCBhc3luY0pTRE9NIH0gZnJvbSAnanNkb20tZXh0cmEnO1xuaW1wb3J0IHsgbWluaWZ5IH0gZnJvbSAnaHRtbC1taW5pZmllcic7XG5pbXBvcnQgcGF0aCBmcm9tICd1cGF0aDInO1xuaW1wb3J0IHsgc3RyaW5naWZ5IH0gZnJvbSAnbWRjb25mMic7XG5pbXBvcnQgeyBDb25zb2xlIH0gZnJvbSAnZGVidWctY29sb3IyJztcbmltcG9ydCBleGVjYWxsIGZyb20gJ2V4ZWNhbGwyJztcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgZml4SlF1ZXJ5IGZyb20gJ0Bub2RlLW5vdmVsL2VwdWItdXRpbC9saWIvZXh0cmFjdC9qcXVlcnknO1xuaW1wb3J0IGZpeEh0bWwsIHsgZml4SHRtbDIgfSBmcm9tICdAbm9kZS1ub3ZlbC9lcHViLXV0aWwvbGliL2V4dHJhY3QvaHRtbCc7XG5pbXBvcnQgZml4VGV4dCBmcm9tICdAbm9kZS1ub3ZlbC9lcHViLXV0aWwvbGliL2V4dHJhY3QvdGV4dCc7XG5cbmV4cG9ydCBjb25zdCBjb25zb2xlID0gbmV3IENvbnNvbGUobnVsbCwge1xuXHRlbmFibGVkOiB0cnVlLFxuXHRpbnNwZWN0T3B0aW9uczoge1xuXHRcdGNvbG9yczogdHJ1ZSxcblx0fSxcblx0Y2hhbGtPcHRpb25zOiB7XG5cdFx0ZW5hYmxlZDogdHJ1ZSxcblx0fSxcbn0pO1xuXG5jb25zb2xlLmVuYWJsZWRDb2xvciA9IHRydWU7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUltYWdlcyBleHRlbmRzIFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbntcblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDYWNoZVxue1xuXHRfYXR0YWNoPzogUmVjb3JkPHN0cmluZywge1xuXHRcdGltYWdlczogSUltYWdlcyxcblx0fT5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRmlsZVxue1xuXHRpbmRleDogbnVtYmVyO1xuXHRuYW1lOiBzdHJpbmc7XG5cdGlzRGlyOiBib29sZWFuO1xuXHR0aXRsZTogc3RyaW5nO1xuXHRpbm5lclRleHQ6IHN0cmluZztcblx0aW1nczogSUltYWdlcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJUmV0dXJuRGF0YVxue1xuXHR6aXA6IEpTWmlwO1xuXHR0eHRzOiBJRmlsZVtdO1xuXHRmaWxlczoge1xuXHRcdFtrZXk6IHN0cmluZ106IEpTWmlwLkpTWmlwT2JqZWN0O1xuXHR9O1xuXHRjYWNoZTogSUNhY2hlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXV0b0V4dHJhY3Qoc3JjRmlsZTogc3RyaW5nLCBzZXR0aW5nPzoge1xuXHRjd2Q/OiBzdHJpbmdcbn0pXG57XG5cdHJldHVybiBsb2FkKHNyY0ZpbGUpXG5cdFx0LnRhcChhc3luYyAoZGF0YSkgPT5cblx0XHR7XG5cdFx0XHRjb25zdCBjd2QgPSBzZXR0aW5nICYmIHNldHRpbmcuY3dkIHx8IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBmaXhGaWxlbmFtZShwYXRoLmJhc2VuYW1lKHNyY0ZpbGUpKSk7XG5cblx0XHRcdGxldCBvcHRpb25zID0ge1xuXHRcdFx0XHQuLi5kYXRhLFxuXHRcdFx0XHRjd2QsXG5cdFx0XHR9O1xuXG5cdFx0XHRjb25zb2xlLmRpcih7XG5cdFx0XHRcdHNyY0ZpbGUsXG5cdFx0XHRcdGN3ZCxcblx0XHRcdH0pO1xuXG5cdFx0XHRyZXR1cm4gQmx1ZWJpcmQuYWxsKFtcblx0XHRcdFx0c2F2ZVR4dChvcHRpb25zKSxcblx0XHRcdFx0c2F2ZUF0dGFjaChvcHRpb25zKVxuXHRcdFx0XSk7XG5cdFx0fSlcblx0XHQ7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGF1dG9FeHRyYWN0XG5cbmV4cG9ydCBmdW5jdGlvbiBmaXhGaWxlbmFtZShmaWxlOiBzdHJpbmcpXG57XG5cdHJldHVybiB0cmltRmlsZW5hbWUoZGVjb2RlVVJJQ29tcG9uZW50KGZpbGUpKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVmZmVyKGJ1ZjogQnVmZmVyLCBjYWNoZTogSUNhY2hlID0ge30pXG57XG5cdHJldHVybiBCbHVlYmlyZC5yZXNvbHZlKEpTWmlwLmxvYWRBc3luYyhidWYsIHtcblx0XHRcdGRlY29kZUZpbGVOYW1lKGJ5dGVzKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KGRlY29kZShieXRlcykpXG5cdFx0XHR9LFxuXHRcdH0pKVxuXHRcdC50aGVuPElSZXR1cm5EYXRhPihhc3luYyAoemlwKSA9PlxuXHRcdHtcblx0XHRcdGxldCB0eHRzID0gYXdhaXQgZmlsZXMoemlwLmZpbGUoL1xcLig/OnhodG1sfGh0bWw/KSQvKSwgY2FjaGUpO1xuXG5cdFx0XHRyZXR1cm4gQmx1ZWJpcmQucHJvcHMoe1xuXHRcdFx0XHR6aXAsXG5cdFx0XHRcdHR4dHMsXG5cdFx0XHRcdGZpbGVzOiB6aXAuZmlsZXMsXG5cdFx0XHRcdGNhY2hlLFxuXHRcdFx0fSlcblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbGVzKGZpbGVzOiBKU1ppcC5KU1ppcE9iamVjdFtdLCBjYWNoZTogSUNhY2hlID0ge30pXG57XG5cdGlmIChjYWNoZS5fYXR0YWNoID09IG51bGwpXG5cdHtcblx0XHRjYWNoZS5fYXR0YWNoID0ge307XG5cdH1cblxuXHRyZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZShmaWxlcylcblx0XHQubWFwKGFzeW5jIChmaWxlLCBpbmRleCkgPT4ge1xuXHRcdFx0bGV0IGJ1ZiA9IGF3YWl0IGZpbGUuYXN5bmMoXCJub2RlYnVmZmVyXCIpXG5cdFx0XHRcdC50aGVuKGRlY29kZSlcblx0XHRcdFx0LnRoZW4oYnVmID0+IHtcblx0XHRcdFx0XHRyZXR1cm4gZml4SHRtbDIoYnVmLnRvU3RyaW5nKCkpO1xuXHRcdFx0XHR9KVxuXHRcdFx0O1xuXG5cdFx0XHRsZXQganNkb20gPSBhd2FpdCBhc3luY0pTRE9NKGJ1Zik7XG5cdFx0XHRsZXQgeyAkLCBkb2N1bWVudCB9ID0ganNkb207XG5cblx0XHRcdGZpeEpRdWVyeSgkKCdib2R5JyksICQpO1xuXG5cdFx0XHQkKCdib2R5JykuaHRtbChmdW5jdGlvbiAoaSwgb2xkKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gZml4SHRtbDIob2xkKTtcblx0XHRcdH0pO1xuXG5cdFx0XHRsZXQgdGl0bGU6IHN0cmluZyA9IGRvY3VtZW50LnRpdGxlO1xuXG5cdFx0XHRsZXQgX3BhcnNlID0gcGF0aC5wYXJzZShmaWxlLm5hbWUpO1xuXHRcdFx0bGV0IF9pZCA9IGZpeEZpbGVuYW1lKF9wYXJzZS5uYW1lKS5yZXBsYWNlKC9bXlxcd19cXC1dKy9nLCAnJykuc2xpY2UoMCwgMjApO1xuXG5cdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRjYWNoZS5fYXR0YWNoW19wYXJzZS5kaXJdID0gY2FjaGUuX2F0dGFjaFtfcGFyc2UuZGlyXSB8fCB7fTtcblxuXHRcdFx0Y2FjaGUuX2F0dGFjaFtfcGFyc2UuZGlyXS5pbWFnZXMgPSBjYWNoZS5fYXR0YWNoW19wYXJzZS5kaXJdLmltYWdlcyB8fCB7fTtcblxuXHRcdFx0bGV0IGltZ3M6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcblxuXHRcdFx0JCgnaW1nJykuZWFjaCgoaSwgZWxlbSkgPT4ge1xuXG5cdFx0XHRcdGxldCBfdGhpcyA9ICQoZWxlbSk7XG5cdFx0XHRcdGxldCBzcmMgPSAoX3RoaXMuYXR0cignc3JjJykgfHwgJycpLnRyaW0oKTtcblxuXHRcdFx0XHRpZiAoc3JjKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bGV0IF9uYW1lID0gX2lkICsgaS50b1N0cmluZygpLnBhZFN0YXJ0KDMsICcwJyk7XG5cblx0XHRcdFx0XHR3aGlsZSAoY2FjaGUuX2F0dGFjaFtfcGFyc2UuZGlyXS5pbWFnZXNbX25hbWVdICE9IG51bGwpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0X25hbWUgPSBfaWQgKyAoKytpKS50b1N0cmluZygpLnBhZFN0YXJ0KDMsICcwJyk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0c3JjID0gZGVjb2RlVVJJQ29tcG9uZW50KHNyYyk7XG5cblx0XHRcdFx0XHRpbWdzW19uYW1lXSA9IHNyYztcblx0XHRcdFx0XHRjYWNoZS5fYXR0YWNoW19wYXJzZS5kaXJdLmltYWdlc1tfbmFtZV0gPSBzcmM7XG5cblx0XHRcdFx0XHRfdGhpcy5hZnRlcihgXFxuKOWclueJhyR7X25hbWV9KVxcbmApO1xuXHRcdFx0XHRcdF90aGlzLnJlbW92ZSgpO1xuXHRcdFx0XHR9XG5cblx0XHRcdH0pO1xuXG5cdFx0XHRsZXQgaW5uZXJUZXh0ID0gZml4VGV4dCgkKGRvY3VtZW50LmJvZHkpLnRleHQoKSk7XG5cblx0XHRcdHJldHVybiA8SUZpbGU+e1xuXHRcdFx0XHRpbmRleCxcblx0XHRcdFx0bmFtZTogZmlsZS5uYW1lLFxuXHRcdFx0XHRpc0RpcjogZmlsZS5kaXIsXG5cdFx0XHRcdHRpdGxlLFxuXHRcdFx0XHRpbm5lclRleHQsXG5cdFx0XHRcdGltZ3MsXG5cdFx0XHR9XG5cdFx0fSlcblx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2F2ZUF0dGFjaChvcHRpb25zOiBJUmV0dXJuRGF0YSAmIHtcblx0Y3dkOiBzdHJpbmcsXG59KVxue1xuXHRyZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZShPYmplY3QuZW50cmllcyhvcHRpb25zLmNhY2hlLl9hdHRhY2gpKVxuXHRcdC5tYXAoYXN5bmMgKFtkaXIsIGRhdGFdKSA9PlxuXHRcdHtcblx0XHRcdGxldCBjd2QgPSBwYXRoLmpvaW4ob3B0aW9ucy5jd2QsIGRpcik7XG5cblx0XHRcdGRhdGEgPSBjbG9uZURlZXAoZGF0YSk7XG5cblx0XHRcdGF3YWl0IEJsdWViaXJkXG5cdFx0XHRcdC5yZXNvbHZlKE9iamVjdC5lbnRyaWVzKGRhdGEuaW1hZ2VzKSlcblx0XHRcdFx0Lm1hcChhc3luYyAoW2lkLCBzcmNdLCBpbmRleCwgbGVuZ3RoKSA9PiB7XG5cblx0XHRcdFx0XHRsZXQgX3BhcnNlID0gcGF0aC5wYXJzZShzcmMpO1xuXG5cdFx0XHRcdFx0bGV0IF9zcmMgPSBwYXRoLmpvaW4oX3BhcnNlLmRpciwgaWQgKyBfcGFyc2UuZXh0KTtcblxuXHRcdFx0XHRcdGxldCBfaW1nID0gcGF0aC5qb2luKGRpciwgc3JjKTtcblx0XHRcdFx0XHRsZXQgX2ltZ19wYXRoID0gcGF0aC5qb2luKGN3ZCwgX3NyYyk7XG5cblx0XHRcdFx0XHRkYXRhLmltYWdlc1tpZF0gPSBfc3JjO1xuXG5cdFx0XHRcdFx0cmV0dXJuIEJsdWViaXJkXG5cdFx0XHRcdFx0XHQucmVzb2x2ZShvcHRpb25zLnppcC5maWxlKF9pbWcpKVxuXHRcdFx0XHRcdFx0LnRoZW4odiA9PiB2LmFzeW5jKCdub2RlYnVmZmVyJykpXG5cdFx0XHRcdFx0XHQudGhlbihidWYgPT5cblx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0Y29uc29sZS5ncmF5KGBbaW1nXVske3BhZE51bShpbmRleCl9LyR7cGFkTnVtKGxlbmd0aCl9XWAsIF9pbWdfcGF0aCk7XG5cblx0XHRcdFx0XHRcdFx0cmV0dXJuIG91dHB1dEZpbGUoX2ltZ19wYXRoLCBidWYpXG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdFx0LmNhdGNoKGUgPT5cblx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0Y29uc29sZS5lcnJvcihlLm1lc3NhZ2UsIHtcblx0XHRcdFx0XHRcdFx0XHRkaXIsXG5cdFx0XHRcdFx0XHRcdFx0bmFtZTogc3JjLFxuXHRcdFx0XHRcdFx0XHRcdF9pbWcsXG5cdFx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdFx0O1xuXG5cdFx0XHRcdH0pXG5cdFx0XHQ7XG5cblx0XHRcdHJldHVybiBvdXRwdXRGaWxlKHBhdGguam9pbihjd2QsICdBVFRBQ0gubWQnKSwgc3RyaW5naWZ5KHtcblx0XHRcdFx0YXR0YWNoOiBkYXRhLFxuXHRcdFx0fSkpXG5cdFx0fSlcblx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbG9hZChmaWxlOiBzdHJpbmcsIGNhY2hlOiBJQ2FjaGUgPSB7fSlcbntcblx0cmV0dXJuIEJsdWViaXJkLnJlc29sdmUocmVhZEZpbGUoZmlsZSkpLnRoZW4oYnVmID0+IGJ1ZmZlcihidWYsIGNhY2hlKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhZE51bShuOiBzdHJpbmcgfCBudW1iZXIpXG57XG5cdHJldHVybiBuLnRvU3RyaW5nKCkucGFkU3RhcnQoMywgJzAnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNhdmVUeHQob3B0aW9uczogSVJldHVybkRhdGEgJiB7XG5cdGN3ZDogc3RyaW5nLFxufSlcbntcblx0cmV0dXJuIEJsdWViaXJkXG5cdFx0LnJlc29sdmUob3B0aW9ucy50eHRzKVxuXHRcdC5tYXAoYXN5bmMgKGZpbGUsIGluZGV4LCBsZW5ndGgpID0+XG5cdFx0e1xuXHRcdFx0bGV0IF9wYXJzZSA9IHBhdGgucGFyc2UoZmlsZS5uYW1lKTtcblxuXHRcdFx0bGV0IGZpbGVuYW1lID0gcGF0aC5qb2luKG9wdGlvbnMuY3dkLCBfcGFyc2UuZGlyLCBfcGFyc2UubmFtZSArICdfJyArIGZpeEZpbGVuYW1lKGZpbGUudGl0bGUpICsgJy50eHQnKTtcblxuXHRcdFx0Y29uc29sZS5ncmF5LmxvZyhgW3R4dF1bJHtwYWROdW0oaW5kZXgpfS8ke3BhZE51bShsZW5ndGgpfV1gLCBmaWxlbmFtZSk7XG5cdFx0XHRhd2FpdCBvdXRwdXRGaWxlKGZpbGVuYW1lLCBmaWxlLmlubmVyVGV4dCk7XG5cblx0XHRcdHJldHVybiBmaWxlbmFtZVxuXHRcdH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0JhZE5hbWUoaW5wdXQ6IHN0cmluZylcbntcblx0cmV0dXJuIC9pbmRleHxeaW1nJHxcXGR7MTAsfS9pLnRlc3QoaW5wdXQpIHx8IGlzRW5jb2RlVVJJKGlucHV0KSB8fCBpc0hhc2hlZExpa2UoaW5wdXQpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0hhc2hlZExpa2UoaW5wdXQ6IHN0cmluZywgbWF4Q291bnQ6IG51bWJlciA9IDMpXG57XG5cdGxldCByID0gZXhlY2FsbCgvKFthLWZdWzAtOV18WzAtOV1bYS1mXSkvaWcsIGlucHV0KTtcblxuXHRyZXR1cm4gci5sZW5ndGggPj0gbWF4Q291bnQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0VuY29kZVVSSShpbnB1dDogc3RyaW5nLCBtYXhDb3VudDogbnVtYmVyID0gMylcbntcblx0bGV0IHIgPSBleGVjYWxsKC8oJVswLTlhLWZdezIsfSkvaWcsIGlucHV0KTtcblxuXHRyZXR1cm4gci5sZW5ndGggPj0gbWF4Q291bnQ7XG59XG4iXX0=