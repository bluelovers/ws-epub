"use strict";
/**
 * Created by user on 2019/7/10.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const JSZip = require("jszip");
const Bluebird = require("bluebird");
const fs_iconv_1 = require("fs-iconv");
const iconv_jschardet_1 = require("iconv-jschardet");
const jsdom_extra_1 = require("jsdom-extra");
const html_minifier_1 = require("html-minifier");
const upath2_1 = require("upath2");
const mdconf2_1 = require("mdconf2");
const debug_color2_1 = require("debug-color2");
exports.console = new debug_color2_1.Console(null, {
    enabled: true,
    inspectOptions: {
        colors: true,
    },
    chalkOptions: {
        enabled: true,
    },
});
exports.console.enabledColor = true;
function autoExtract(srcFile, setting) {
    return load(srcFile)
        .tap(async (data) => {
        const cwd = setting && setting.cwd || upath2_1.default.join(process.cwd(), fixFilename(upath2_1.default.basename(srcFile)));
        let options = {
            ...data,
            cwd,
        };
        exports.console.dir({
            srcFile,
            cwd,
        });
        return Bluebird.all([
            saveTxt(options),
            saveAttach(options)
        ]);
    });
}
exports.autoExtract = autoExtract;
exports.default = autoExtract;
function fixFilename(file) {
    return fs_iconv_1.trimFilename(decodeURIComponent(file));
}
exports.fixFilename = fixFilename;
function buffer(buf, cache = {}) {
    return Bluebird.resolve(JSZip.loadAsync(buf, {
        decodeFileName(bytes) {
            return decodeURIComponent(iconv_jschardet_1.decode(bytes));
        },
    }))
        .then(async (zip) => {
        let txts = await files(zip.file(/\.(?:xhtml|html?)$/), cache);
        return Bluebird.props({
            zip,
            txts,
            files: zip.files,
            cache,
        });
    });
}
exports.buffer = buffer;
function files(files, cache = {}) {
    if (cache._attach == null) {
        cache._attach = {};
    }
    return Bluebird.resolve(files)
        .map(async (file, index) => {
        let buf = await file.async("nodebuffer")
            .then(iconv_jschardet_1.decode)
            .then(buf => {
            try {
                return fixHtml(buf.toString());
            }
            catch (e) {
            }
            return buf;
        });
        let jsdom = await jsdom_extra_1.asyncJSDOM(buf);
        let { $, document } = jsdom;
        let title = document.title;
        let _parse = upath2_1.default.parse(file.name);
        let _id = fixFilename(_parse.name).replace(/[^\w_\-]+/g, '').slice(0, 20);
        // @ts-ignore
        cache._attach[_parse.dir] = cache._attach[_parse.dir] || {};
        cache._attach[_parse.dir].images = cache._attach[_parse.dir].images || {};
        let imgs = {};
        $('img').each((i, elem) => {
            let _this = $(elem);
            let src = (_this.attr('src') || '').trim();
            if (src) {
                let _name = _id + i.toString().padStart(3, '0');
                while (cache._attach[_parse.dir].images[_name] != null) {
                    _name = _id + (++i).toString().padStart(3, '0');
                }
                src = decodeURIComponent(src);
                imgs[_name] = src;
                cache._attach[_parse.dir].images[_name] = src;
                _this.after(`\n(圖片${_name})\n`);
                _this.remove();
            }
        });
        let innerText = $(document.body)
            .text()
            .replace(/^\n{2,}|\n{2,}$/g, '\n');
        return {
            index,
            name: file.name,
            isDir: file.dir,
            title,
            innerText,
            imgs,
        };
    });
}
exports.files = files;
function saveAttach(options) {
    return Bluebird.resolve(Object.entries(options.cache._attach))
        .map(async ([dir, data]) => {
        let cwd = upath2_1.default.join(options.cwd, dir);
        await Bluebird
            .resolve(Object.entries(data.images))
            .map(async ([id, src], index, length) => {
            let _img = upath2_1.default.join(dir, src);
            let _img_path = upath2_1.default.join(cwd, src);
            return Bluebird
                .resolve(options.zip.file(_img))
                .then(v => v.async('nodebuffer'))
                .then(buf => {
                exports.console.gray(`[img][${padNum(index)}/${padNum(length)}]`, _img_path);
                return fs_iconv_1.outputFile(_img_path, buf);
            })
                .catch(e => {
                exports.console.error(e.message, {
                    dir,
                    name: src,
                    _img,
                });
            });
        });
        return fs_iconv_1.outputFile(upath2_1.default.join(cwd, 'ATTACH.md'), mdconf2_1.stringify({
            attach: data,
        }));
    });
}
exports.saveAttach = saveAttach;
function load(file, cache = {}) {
    return Bluebird.resolve(fs_iconv_1.readFile(file)).then(buf => buffer(buf, cache));
}
exports.load = load;
function padNum(n) {
    return n.toString().padStart(3, '0');
}
exports.padNum = padNum;
function saveTxt(options) {
    return Bluebird
        .resolve(options.txts)
        .map(async (file, index, length) => {
        let _parse = upath2_1.default.parse(file.name);
        let filename = upath2_1.default.join(options.cwd, _parse.dir, _parse.name + '_' + fixFilename(file.title) + '.txt');
        exports.console.gray.log(`[txt][${padNum(index)}/${padNum(length)}]`, filename);
        await fs_iconv_1.outputFile(filename, file.innerText);
        return filename;
    });
}
exports.saveTxt = saveTxt;
function fixHtml(html) {
    return html_minifier_1.minify(html, {
        collapseWhitespace: true,
        preserveLineBreaks: true,
        conservativeCollapse: true,
        caseSensitive: true,
    });
}
exports.fixHtml = fixHtml;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsK0JBQWdDO0FBQ2hDLHFDQUFzQztBQUN0Qyx1Q0FBOEQ7QUFDOUQscURBQXlFO0FBRXpFLDZDQUFxRTtBQUNyRSxpREFBdUM7QUFDdkMsbUNBQTBCO0FBQzFCLHFDQUFvQztBQUNwQywrQ0FBdUM7QUFFMUIsUUFBQSxPQUFPLEdBQUcsSUFBSSxzQkFBTyxDQUFDLElBQUksRUFBRTtJQUN4QyxPQUFPLEVBQUUsSUFBSTtJQUNiLGNBQWMsRUFBRTtRQUNmLE1BQU0sRUFBRSxJQUFJO0tBQ1o7SUFDRCxZQUFZLEVBQUU7UUFDYixPQUFPLEVBQUUsSUFBSTtLQUNiO0NBQ0QsQ0FBQyxDQUFDO0FBRUgsZUFBTyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7QUFrQzVCLFNBQWdCLFdBQVcsQ0FBQyxPQUFlLEVBQUUsT0FFNUM7SUFFQSxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDbEIsR0FBRyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRTtRQUVuQixNQUFNLEdBQUcsR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLEdBQUcsSUFBSSxnQkFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsV0FBVyxDQUFDLGdCQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVwRyxJQUFJLE9BQU8sR0FBRztZQUNiLEdBQUcsSUFBSTtZQUNQLEdBQUc7U0FDSCxDQUFDO1FBRUYsZUFBTyxDQUFDLEdBQUcsQ0FBQztZQUNYLE9BQU87WUFDUCxHQUFHO1NBQ0gsQ0FBQyxDQUFDO1FBRUgsT0FBTyxRQUFRLENBQUMsR0FBRyxDQUFDO1lBQ25CLE9BQU8sQ0FBQyxPQUFPLENBQUM7WUFDaEIsVUFBVSxDQUFDLE9BQU8sQ0FBQztTQUNuQixDQUFDLENBQUM7SUFD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Q0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRW5DLElBQUksUUFBUSxHQUFHLGdCQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsSUFBSSxHQUFHLEdBQUcsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO1FBRXhHLGVBQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3hFLE1BQU0scUJBQVUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTNDLE9BQU8sUUFBUSxDQUFBO0lBQ2hCLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQWpCRCwwQkFpQkM7QUFFRCxTQUFnQixPQUFPLENBQUMsSUFBWTtJQUVuQyxPQUFPLHNCQUFNLENBQUMsSUFBSSxFQUFFO1FBQ25CLGtCQUFrQixFQUFFLElBQUk7UUFDeEIsa0JBQWtCLEVBQUUsSUFBSTtRQUN4QixvQkFBb0IsRUFBRSxJQUFJO1FBQzFCLGFBQWEsRUFBRSxJQUFJO0tBQ25CLENBQUMsQ0FBQztBQUNKLENBQUM7QUFSRCwwQkFRQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTkvNy8xMC5cbiAqL1xuXG5pbXBvcnQgSlNaaXAgPSByZXF1aXJlKCdqc3ppcCcpO1xuaW1wb3J0IEJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmltcG9ydCB7IG91dHB1dEZpbGUsIHJlYWRGaWxlLCB0cmltRmlsZW5hbWUgfSBmcm9tICdmcy1pY29udic7XG5pbXBvcnQgeyBCdWZmZXJGcm9tLCBkZWNvZGUsIEVOVU1fTk9ERV9FTkNPRElORyB9IGZyb20gJ2ljb252LWpzY2hhcmRldCc7XG5pbXBvcnQgbWljcm9tYXRjaCA9IHJlcXVpcmUoJ21pY3JvbWF0Y2gnKTtcbmltcG9ydCB7IEpTRE9NLCBjcmVhdGVKU0RPTSwgSUpTRE9NLCBhc3luY0pTRE9NIH0gZnJvbSAnanNkb20tZXh0cmEnO1xuaW1wb3J0IHsgbWluaWZ5IH0gZnJvbSAnaHRtbC1taW5pZmllcic7XG5pbXBvcnQgcGF0aCBmcm9tICd1cGF0aDInO1xuaW1wb3J0IHsgc3RyaW5naWZ5IH0gZnJvbSAnbWRjb25mMic7XG5pbXBvcnQgeyBDb25zb2xlIH0gZnJvbSAnZGVidWctY29sb3IyJztcblxuZXhwb3J0IGNvbnN0IGNvbnNvbGUgPSBuZXcgQ29uc29sZShudWxsLCB7XG5cdGVuYWJsZWQ6IHRydWUsXG5cdGluc3BlY3RPcHRpb25zOiB7XG5cdFx0Y29sb3JzOiB0cnVlLFxuXHR9LFxuXHRjaGFsa09wdGlvbnM6IHtcblx0XHRlbmFibGVkOiB0cnVlLFxuXHR9LFxufSk7XG5cbmNvbnNvbGUuZW5hYmxlZENvbG9yID0gdHJ1ZTtcblxuZXhwb3J0IGludGVyZmFjZSBJSW1hZ2VzIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgc3RyaW5nPlxue1xuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNhY2hlXG57XG5cdF9hdHRhY2g/OiBSZWNvcmQ8c3RyaW5nLCB7XG5cdFx0aW1hZ2VzOiBJSW1hZ2VzLFxuXHR9PlxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElGaWxlXG57XG5cdGluZGV4OiBudW1iZXI7XG5cdG5hbWU6IHN0cmluZztcblx0aXNEaXI6IGJvb2xlYW47XG5cdHRpdGxlOiBzdHJpbmc7XG5cdGlubmVyVGV4dDogc3RyaW5nO1xuXHRpbWdzOiBJSW1hZ2VzO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElSZXR1cm5EYXRhXG57XG5cdHppcDogSlNaaXA7XG5cdHR4dHM6IElGaWxlW107XG5cdGZpbGVzOiB7XG5cdFx0W2tleTogc3RyaW5nXTogSlNaaXAuSlNaaXBPYmplY3Q7XG5cdH07XG5cdGNhY2hlOiBJQ2FjaGU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdXRvRXh0cmFjdChzcmNGaWxlOiBzdHJpbmcsIHNldHRpbmc/OiB7XG5cdGN3ZD86IHN0cmluZ1xufSlcbntcblx0cmV0dXJuIGxvYWQoc3JjRmlsZSlcblx0XHQudGFwKGFzeW5jIChkYXRhKSA9PlxuXHRcdHtcblx0XHRcdGNvbnN0IGN3ZCA9IHNldHRpbmcgJiYgc2V0dGluZy5jd2QgfHwgcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksIGZpeEZpbGVuYW1lKHBhdGguYmFzZW5hbWUoc3JjRmlsZSkpKTtcblxuXHRcdFx0bGV0IG9wdGlvbnMgPSB7XG5cdFx0XHRcdC4uLmRhdGEsXG5cdFx0XHRcdGN3ZCxcblx0XHRcdH07XG5cblx0XHRcdGNvbnNvbGUuZGlyKHtcblx0XHRcdFx0c3JjRmlsZSxcblx0XHRcdFx0Y3dkLFxuXHRcdFx0fSk7XG5cblx0XHRcdHJldHVybiBCbHVlYmlyZC5hbGwoW1xuXHRcdFx0XHRzYXZlVHh0KG9wdGlvbnMpLFxuXHRcdFx0XHRzYXZlQXR0YWNoKG9wdGlvbnMpXG5cdFx0XHRdKTtcblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGRlZmF1bHQgYXV0b0V4dHJhY3RcblxuZXhwb3J0IGZ1bmN0aW9uIGZpeEZpbGVuYW1lKGZpbGU6IHN0cmluZylcbntcblx0cmV0dXJuIHRyaW1GaWxlbmFtZShkZWNvZGVVUklDb21wb25lbnQoZmlsZSkpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWZmZXIoYnVmOiBCdWZmZXIsIGNhY2hlOiBJQ2FjaGUgPSB7fSlcbntcblx0cmV0dXJuIEJsdWViaXJkLnJlc29sdmUoSlNaaXAubG9hZEFzeW5jKGJ1Ziwge1xuXHRcdFx0ZGVjb2RlRmlsZU5hbWUoYnl0ZXMpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoZGVjb2RlKGJ5dGVzKSlcblx0XHRcdH0sXG5cdFx0fSkpXG5cdFx0LnRoZW48SVJldHVybkRhdGE+KGFzeW5jICh6aXApID0+XG5cdFx0e1xuXHRcdFx0bGV0IHR4dHMgPSBhd2FpdCBmaWxlcyh6aXAuZmlsZSgvXFwuKD86eGh0bWx8aHRtbD8pJC8pLCBjYWNoZSk7XG5cblx0XHRcdHJldHVybiBCbHVlYmlyZC5wcm9wcyh7XG5cdFx0XHRcdHppcCxcblx0XHRcdFx0dHh0cyxcblx0XHRcdFx0ZmlsZXM6IHppcC5maWxlcyxcblx0XHRcdFx0Y2FjaGUsXG5cdFx0XHR9KVxuXHRcdH0pXG5cdFx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmlsZXMoZmlsZXM6IEpTWmlwLkpTWmlwT2JqZWN0W10sIGNhY2hlOiBJQ2FjaGUgPSB7fSlcbntcblx0aWYgKGNhY2hlLl9hdHRhY2ggPT0gbnVsbClcblx0e1xuXHRcdGNhY2hlLl9hdHRhY2ggPSB7fTtcblx0fVxuXG5cdHJldHVybiBCbHVlYmlyZC5yZXNvbHZlKGZpbGVzKVxuXHRcdC5tYXAoYXN5bmMgKGZpbGUsIGluZGV4KSA9PiB7XG5cdFx0XHRsZXQgYnVmID0gYXdhaXQgZmlsZS5hc3luYyhcIm5vZGVidWZmZXJcIilcblx0XHRcdFx0LnRoZW4oZGVjb2RlKVxuXHRcdFx0XHQudGhlbihidWYgPT4ge1xuXG5cdFx0XHRcdFx0dHJ5XG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmV0dXJuIGZpeEh0bWwoYnVmLnRvU3RyaW5nKCkpXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGNhdGNoIChlKVxuXHRcdFx0XHRcdHtcblxuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdHJldHVybiBidWY7XG5cdFx0XHRcdH0pXG5cdFx0XHQ7XG5cblx0XHRcdGxldCBqc2RvbSA9IGF3YWl0IGFzeW5jSlNET00oYnVmKTtcblx0XHRcdGxldCB7ICQsIGRvY3VtZW50IH0gPSBqc2RvbTtcblxuXHRcdFx0bGV0IHRpdGxlOiBzdHJpbmcgPSBkb2N1bWVudC50aXRsZTtcblxuXHRcdFx0bGV0IF9wYXJzZSA9IHBhdGgucGFyc2UoZmlsZS5uYW1lKTtcblx0XHRcdGxldCBfaWQgPSBmaXhGaWxlbmFtZShfcGFyc2UubmFtZSkucmVwbGFjZSgvW15cXHdfXFwtXSsvZywgJycpLnNsaWNlKDAsIDIwKTtcblxuXHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0Y2FjaGUuX2F0dGFjaFtfcGFyc2UuZGlyXSA9IGNhY2hlLl9hdHRhY2hbX3BhcnNlLmRpcl0gfHwge307XG5cblx0XHRcdGNhY2hlLl9hdHRhY2hbX3BhcnNlLmRpcl0uaW1hZ2VzID0gY2FjaGUuX2F0dGFjaFtfcGFyc2UuZGlyXS5pbWFnZXMgfHwge307XG5cblx0XHRcdGxldCBpbWdzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG5cblx0XHRcdCQoJ2ltZycpLmVhY2goKGksIGVsZW0pID0+IHtcblxuXHRcdFx0XHRsZXQgX3RoaXMgPSAkKGVsZW0pO1xuXHRcdFx0XHRsZXQgc3JjID0gKF90aGlzLmF0dHIoJ3NyYycpIHx8ICcnKS50cmltKCk7XG5cblx0XHRcdFx0aWYgKHNyYylcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGxldCBfbmFtZSA9IF9pZCArIGkudG9TdHJpbmcoKS5wYWRTdGFydCgzLCAnMCcpO1xuXG5cdFx0XHRcdFx0d2hpbGUgKGNhY2hlLl9hdHRhY2hbX3BhcnNlLmRpcl0uaW1hZ2VzW19uYW1lXSAhPSBudWxsKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdF9uYW1lID0gX2lkICsgKCsraSkudG9TdHJpbmcoKS5wYWRTdGFydCgzLCAnMCcpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdHNyYyA9IGRlY29kZVVSSUNvbXBvbmVudChzcmMpO1xuXG5cdFx0XHRcdFx0aW1nc1tfbmFtZV0gPSBzcmM7XG5cdFx0XHRcdFx0Y2FjaGUuX2F0dGFjaFtfcGFyc2UuZGlyXS5pbWFnZXNbX25hbWVdID0gc3JjO1xuXG5cdFx0XHRcdFx0X3RoaXMuYWZ0ZXIoYFxcbijlnJbniYcke19uYW1lfSlcXG5gKTtcblx0XHRcdFx0XHRfdGhpcy5yZW1vdmUoKTtcblx0XHRcdFx0fVxuXG5cdFx0XHR9KTtcblxuXHRcdFx0bGV0IGlubmVyVGV4dDogc3RyaW5nID0gJChkb2N1bWVudC5ib2R5KVxuXHRcdFx0XHQudGV4dCgpXG5cdFx0XHRcdC5yZXBsYWNlKC9eXFxuezIsfXxcXG57Mix9JC9nLCAnXFxuJylcblx0XHRcdDtcblxuXHRcdFx0cmV0dXJuIDxJRmlsZT57XG5cdFx0XHRcdGluZGV4LFxuXHRcdFx0XHRuYW1lOiBmaWxlLm5hbWUsXG5cdFx0XHRcdGlzRGlyOiBmaWxlLmRpcixcblx0XHRcdFx0dGl0bGUsXG5cdFx0XHRcdGlubmVyVGV4dCxcblx0XHRcdFx0aW1ncyxcblx0XHRcdH1cblx0XHR9KVxuXHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzYXZlQXR0YWNoKG9wdGlvbnM6IElSZXR1cm5EYXRhICYge1xuXHRjd2Q6IHN0cmluZyxcbn0pXG57XG5cdHJldHVybiBCbHVlYmlyZC5yZXNvbHZlKE9iamVjdC5lbnRyaWVzKG9wdGlvbnMuY2FjaGUuX2F0dGFjaCkpXG5cdFx0Lm1hcChhc3luYyAoW2RpciwgZGF0YV0pID0+XG5cdFx0e1xuXHRcdFx0bGV0IGN3ZCA9IHBhdGguam9pbihvcHRpb25zLmN3ZCwgZGlyKTtcblxuXHRcdFx0YXdhaXQgQmx1ZWJpcmRcblx0XHRcdFx0LnJlc29sdmUoT2JqZWN0LmVudHJpZXMoZGF0YS5pbWFnZXMpKVxuXHRcdFx0XHQubWFwKGFzeW5jIChbaWQsIHNyY10sIGluZGV4LCBsZW5ndGgpID0+IHtcblx0XHRcdFx0XHRsZXQgX2ltZyA9IHBhdGguam9pbihkaXIsIHNyYyk7XG5cdFx0XHRcdFx0bGV0IF9pbWdfcGF0aCA9IHBhdGguam9pbihjd2QsIHNyYyk7XG5cblx0XHRcdFx0XHRyZXR1cm4gQmx1ZWJpcmRcblx0XHRcdFx0XHRcdC5yZXNvbHZlKG9wdGlvbnMuemlwLmZpbGUoX2ltZykpXG5cdFx0XHRcdFx0XHQudGhlbih2ID0+IHYuYXN5bmMoJ25vZGVidWZmZXInKSlcblx0XHRcdFx0XHRcdC50aGVuKGJ1ZiA9PlxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRjb25zb2xlLmdyYXkoYFtpbWddWyR7cGFkTnVtKGluZGV4KX0vJHtwYWROdW0obGVuZ3RoKX1dYCwgX2ltZ19wYXRoKTtcblxuXHRcdFx0XHRcdFx0XHRyZXR1cm4gb3V0cHV0RmlsZShfaW1nX3BhdGgsIGJ1Zilcblx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0XHQuY2F0Y2goZSA9PlxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRjb25zb2xlLmVycm9yKGUubWVzc2FnZSwge1xuXHRcdFx0XHRcdFx0XHRcdGRpcixcblx0XHRcdFx0XHRcdFx0XHRuYW1lOiBzcmMsXG5cdFx0XHRcdFx0XHRcdFx0X2ltZyxcblx0XHRcdFx0XHRcdFx0fSlcblx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0XHQ7XG5cblx0XHRcdFx0fSlcblx0XHRcdDtcblxuXHRcdFx0cmV0dXJuIG91dHB1dEZpbGUocGF0aC5qb2luKGN3ZCwgJ0FUVEFDSC5tZCcpLCBzdHJpbmdpZnkoe1xuXHRcdFx0XHRhdHRhY2g6IGRhdGEsXG5cdFx0XHR9KSlcblx0XHR9KVxuXHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2FkKGZpbGU6IHN0cmluZywgY2FjaGU6IElDYWNoZSA9IHt9KVxue1xuXHRyZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZShyZWFkRmlsZShmaWxlKSkudGhlbihidWYgPT4gYnVmZmVyKGJ1ZiwgY2FjaGUpKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFkTnVtKG46IHN0cmluZyB8IG51bWJlcilcbntcblx0cmV0dXJuIG4udG9TdHJpbmcoKS5wYWRTdGFydCgzLCAnMCcpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2F2ZVR4dChvcHRpb25zOiBJUmV0dXJuRGF0YSAmIHtcblx0Y3dkOiBzdHJpbmcsXG59KVxue1xuXHRyZXR1cm4gQmx1ZWJpcmRcblx0XHQucmVzb2x2ZShvcHRpb25zLnR4dHMpXG5cdFx0Lm1hcChhc3luYyAoZmlsZSwgaW5kZXgsIGxlbmd0aCkgPT5cblx0XHR7XG5cdFx0XHRsZXQgX3BhcnNlID0gcGF0aC5wYXJzZShmaWxlLm5hbWUpO1xuXG5cdFx0XHRsZXQgZmlsZW5hbWUgPSBwYXRoLmpvaW4ob3B0aW9ucy5jd2QsIF9wYXJzZS5kaXIsIF9wYXJzZS5uYW1lICsgJ18nICsgZml4RmlsZW5hbWUoZmlsZS50aXRsZSkgKyAnLnR4dCcpO1xuXG5cdFx0XHRjb25zb2xlLmdyYXkubG9nKGBbdHh0XVske3BhZE51bShpbmRleCl9LyR7cGFkTnVtKGxlbmd0aCl9XWAsIGZpbGVuYW1lKTtcblx0XHRcdGF3YWl0IG91dHB1dEZpbGUoZmlsZW5hbWUsIGZpbGUuaW5uZXJUZXh0KTtcblxuXHRcdFx0cmV0dXJuIGZpbGVuYW1lXG5cdFx0fSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpeEh0bWwoaHRtbDogc3RyaW5nKTogc3RyaW5nXG57XG5cdHJldHVybiBtaW5pZnkoaHRtbCwge1xuXHRcdGNvbGxhcHNlV2hpdGVzcGFjZTogdHJ1ZSxcblx0XHRwcmVzZXJ2ZUxpbmVCcmVha3M6IHRydWUsXG5cdFx0Y29uc2VydmF0aXZlQ29sbGFwc2U6IHRydWUsXG5cdFx0Y2FzZVNlbnNpdGl2ZTogdHJ1ZSxcblx0fSk7XG59Il19