"use strict";
/**
 * Created by user on 2019/7/10.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const JSZip = require("jszip");
const Bluebird = require("bluebird");
const fs_iconv_1 = require("fs-iconv");
const iconv_jschardet_1 = require("iconv-jschardet");
const jsdom_extra_1 = require("jsdom-extra");
const html_minifier_1 = require("html-minifier");
const upath2_1 = require("upath2");
const mdconf2_1 = require("mdconf2");
const debug_color2_1 = require("debug-color2");
const execall2_1 = require("execall2");
const lodash_1 = require("lodash");
exports.console = new debug_color2_1.Console(null, {
    enabled: true,
    inspectOptions: {
        colors: true,
    },
    chalkOptions: {
        enabled: true,
    },
});
exports.console.enabledColor = true;
function autoExtract(srcFile, setting) {
    return load(srcFile)
        .tap(async (data) => {
        const cwd = setting && setting.cwd || upath2_1.default.join(process.cwd(), fixFilename(upath2_1.default.basename(srcFile)));
        let options = {
            ...data,
            cwd,
        };
        exports.console.dir({
            srcFile,
            cwd,
        });
        return Bluebird.all([
            saveTxt(options),
            saveAttach(options)
        ]);
    });
}
exports.autoExtract = autoExtract;
exports.default = autoExtract;
function fixFilename(file) {
    return fs_iconv_1.trimFilename(decodeURIComponent(file));
}
exports.fixFilename = fixFilename;
function buffer(buf, cache = {}) {
    return Bluebird.resolve(JSZip.loadAsync(buf, {
        decodeFileName(bytes) {
            return decodeURIComponent(iconv_jschardet_1.decode(bytes));
        },
    }))
        .then(async (zip) => {
        let txts = await files(zip.file(/\.(?:xhtml|html?)$/), cache);
        return Bluebird.props({
            zip,
            txts,
            files: zip.files,
            cache,
        });
    });
}
exports.buffer = buffer;
function files(files, cache = {}) {
    if (cache._attach == null) {
        cache._attach = {};
    }
    return Bluebird.resolve(files)
        .map(async (file, index) => {
        let buf = await file.async("nodebuffer")
            .then(iconv_jschardet_1.decode)
            .then(buf => {
            try {
                return fixHtml(buf.toString());
            }
            catch (e) {
            }
            return buf;
        });
        let jsdom = await jsdom_extra_1.asyncJSDOM(buf);
        let { $, document } = jsdom;
        let title = document.title;
        let _parse = upath2_1.default.parse(file.name);
        let _id = fixFilename(_parse.name).replace(/[^\w_\-]+/g, '').slice(0, 20);
        // @ts-ignore
        cache._attach[_parse.dir] = cache._attach[_parse.dir] || {};
        cache._attach[_parse.dir].images = cache._attach[_parse.dir].images || {};
        let imgs = {};
        $('img').each((i, elem) => {
            let _this = $(elem);
            let src = (_this.attr('src') || '').trim();
            if (src) {
                let _name = _id + i.toString().padStart(3, '0');
                while (cache._attach[_parse.dir].images[_name] != null) {
                    _name = _id + (++i).toString().padStart(3, '0');
                }
                src = decodeURIComponent(src);
                imgs[_name] = src;
                cache._attach[_parse.dir].images[_name] = src;
                _this.after(`\n(圖片${_name})\n`);
                _this.remove();
            }
        });
        let innerText = $(document.body)
            .text()
            .replace(/^\n{2,}|\n{2,}$/g, '\n');
        return {
            index,
            name: file.name,
            isDir: file.dir,
            title,
            innerText,
            imgs,
        };
    });
}
exports.files = files;
function saveAttach(options) {
    return Bluebird.resolve(Object.entries(options.cache._attach))
        .map(async ([dir, data]) => {
        let cwd = upath2_1.default.join(options.cwd, dir);
        data = lodash_1.cloneDeep(data);
        await Bluebird
            .resolve(Object.entries(data.images))
            .map(async ([id, src], index, length) => {
            let _parse = upath2_1.default.parse(src);
            let _src = upath2_1.default.join(_parse.dir, id + _parse.ext);
            let _img = upath2_1.default.join(dir, src);
            let _img_path = upath2_1.default.join(cwd, _src);
            data.images[id] = _src;
            return Bluebird
                .resolve(options.zip.file(_img))
                .then(v => v.async('nodebuffer'))
                .then(buf => {
                exports.console.gray(`[img][${padNum(index)}/${padNum(length)}]`, _img_path);
                return fs_iconv_1.outputFile(_img_path, buf);
            })
                .catch(e => {
                exports.console.error(e.message, {
                    dir,
                    name: src,
                    _img,
                });
            });
        });
        return fs_iconv_1.outputFile(upath2_1.default.join(cwd, 'ATTACH.md'), mdconf2_1.stringify({
            attach: data,
        }));
    });
}
exports.saveAttach = saveAttach;
function load(file, cache = {}) {
    return Bluebird.resolve(fs_iconv_1.readFile(file)).then(buf => buffer(buf, cache));
}
exports.load = load;
function padNum(n) {
    return n.toString().padStart(3, '0');
}
exports.padNum = padNum;
function saveTxt(options) {
    return Bluebird
        .resolve(options.txts)
        .map(async (file, index, length) => {
        let _parse = upath2_1.default.parse(file.name);
        let filename = upath2_1.default.join(options.cwd, _parse.dir, _parse.name + '_' + fixFilename(file.title) + '.txt');
        exports.console.gray.log(`[txt][${padNum(index)}/${padNum(length)}]`, filename);
        await fs_iconv_1.outputFile(filename, file.innerText);
        return filename;
    });
}
exports.saveTxt = saveTxt;
function fixHtml(html) {
    return html_minifier_1.minify(html, {
        collapseWhitespace: true,
        preserveLineBreaks: true,
        conservativeCollapse: true,
        caseSensitive: true,
    });
}
exports.fixHtml = fixHtml;
function isBadName(input) {
    return /index|^img$|\d{10,}/i.test(input) || isEncodeURI(input) || isHashedLike(input);
}
exports.isBadName = isBadName;
function isHashedLike(input, maxCount = 3) {
    let r = execall2_1.default(/([a-f][0-9]|[0-9][a-f])/ig, input);
    return r.length >= maxCount;
}
exports.isHashedLike = isHashedLike;
function isEncodeURI(input, maxCount = 3) {
    let r = execall2_1.default(/(%[0-9a-f]{2,})/ig, input);
    return r.length >= maxCount;
}
exports.isEncodeURI = isEncodeURI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsK0JBQWdDO0FBQ2hDLHFDQUFzQztBQUN0Qyx1Q0FBOEQ7QUFDOUQscURBQXlFO0FBRXpFLDZDQUFxRTtBQUNyRSxpREFBdUM7QUFDdkMsbUNBQTBCO0FBQzFCLHFDQUFvQztBQUNwQywrQ0FBdUM7QUFDdkMsdUNBQStCO0FBQy9CLG1DQUFtQztBQUV0QixRQUFBLE9BQU8sR0FBRyxJQUFJLHNCQUFPLENBQUMsSUFBSSxFQUFFO0lBQ3hDLE9BQU8sRUFBRSxJQUFJO0lBQ2IsY0FBYyxFQUFFO1FBQ2YsTUFBTSxFQUFFLElBQUk7S0FDWjtJQUNELFlBQVksRUFBRTtRQUNiLE9BQU8sRUFBRSxJQUFJO0tBQ2I7Q0FDRCxDQUFDLENBQUM7QUFFSCxlQUFPLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztBQWtDNUIsU0FBZ0IsV0FBVyxDQUFDLE9BQWUsRUFBRSxPQUU1QztJQUVBLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztTQUNsQixHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFO1FBRW5CLE1BQU0sR0FBRyxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsR0FBRyxJQUFJLGdCQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxXQUFXLENBQUMsZ0JBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXBHLElBQUksT0FBTyxHQUFHO1lBQ2IsR0FBRyxJQUFJO1lBQ1AsR0FBRztTQUNILENBQUM7UUFFRixlQUFPLENBQUMsR0FBRyxDQUFDO1lBQ1gsT0FBTztZQUNQLEdBQUc7U0FDSCxDQUFDLENBQUM7UUFFSCxPQUFPLFFBQVEsQ0FBQyxHQUFHLENBQUM7WUFDbkIsT0FBTyxDQUFDLE9BQU8sQ0FBQztZQUNoQixVQUFVLENBQUMsT0FBTyxDQUFDO1NBQ25CLENBQUMsQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUNEO0FBQ0gsQ0FBQztBQXpCRCxrQ0F5QkM7QUFFRCxrQkFBZSxXQUFXLENBQUE7QUFFMUIsU0FBZ0IsV0FBVyxDQUFDLElBQVk7SUFFdkMsT0FBTyx1QkFBWSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7QUFDOUMsQ0FBQztBQUhELGtDQUdDO0FBRUQsU0FBZ0IsTUFBTSxDQUFDLEdBQVcsRUFBRSxRQUFnQixFQUFFO0lBRXJELE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUMzQyxjQUFjLENBQUMsS0FBSztZQUVuQixPQUFPLGtCQUFrQixDQUFDLHdCQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUN6QyxDQUFDO0tBQ0QsQ0FBQyxDQUFDO1NBQ0YsSUFBSSxDQUFjLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUVoQyxJQUFJLElBQUksR0FBRyxNQUFNLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFOUQsT0FBTyxRQUFRLENBQUMsS0FBSyxDQUFDO1lBQ3JCLEdBQUc7WUFDSCxJQUFJO1lBQ0osS0FBSyxFQUFFLEdBQUcsQ0FBQyxLQUFLO1lBQ2hCLEtBQUs7U0FDTCxDQUFDLENBQUE7SUFDSCxDQUFDLENBQUMsQ0FDRDtBQUNILENBQUM7QUFwQkQsd0JBb0JDO0FBRUQsU0FBZ0IsS0FBSyxDQUFDLEtBQTBCLEVBQUUsUUFBZ0IsRUFBRTtJQUVuRSxJQUFJLEtBQUssQ0FBQyxPQUFPLElBQUksSUFBSSxFQUN6QjtRQUNDLEtBQUssQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO0tBQ25CO0lBRUQsT0FBTyxRQUFRLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztTQUM1QixHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtRQUMxQixJQUFJLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDO2FBQ3RDLElBQUksQ0FBQyx3QkFBTSxDQUFDO2FBQ1osSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBRVgsSUFDQTtnQkFDQyxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQTthQUM5QjtZQUNELE9BQU8sQ0FBQyxFQUNSO2FBRUM7WUFFRCxPQUFPLEdBQUcsQ0FBQztRQUNaLENBQUMsQ0FBQyxDQUNGO1FBRUQsSUFBSSxLQUFLLEdBQUcsTUFBTSx3QkFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2xDLElBQUksRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBRTVCLElBQUksS0FBSyxHQUFXLFFBQVEsQ0FBQyxLQUFLLENBQUM7UUFFbkMsSUFBSSxNQUFNLEdBQUcsZ0JBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25DLElBQUksR0FBRyxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTFFLGFBQWE7UUFDYixLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFNUQsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUM7UUFFMUUsSUFBSSxJQUFJLEdBQTJCLEVBQUUsQ0FBQztRQUV0QyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFO1lBRXpCLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNwQixJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFM0MsSUFBSSxHQUFHLEVBQ1A7Z0JBQ0MsSUFBSSxLQUFLLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUVoRCxPQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLEVBQ3REO29CQUNDLEtBQUssR0FBRyxHQUFHLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7aUJBQ2hEO2dCQUVELEdBQUcsR0FBRyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFFOUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQztnQkFDbEIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQztnQkFFOUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLEtBQUssS0FBSyxDQUFDLENBQUM7Z0JBQ2hDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQzthQUNmO1FBRUYsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLFNBQVMsR0FBVyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQzthQUN0QyxJQUFJLEVBQUU7YUFDTixPQUFPLENBQUMsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLENBQ2xDO1FBRUQsT0FBYztZQUNiLEtBQUs7WUFDTCxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUc7WUFDZixLQUFLO1lBQ0wsU0FBUztZQUNULElBQUk7U0FDSixDQUFBO0lBQ0YsQ0FBQyxDQUFDLENBQ0Y7QUFDRixDQUFDO0FBakZELHNCQWlGQztBQUVELFNBQWdCLFVBQVUsQ0FBQyxPQUUxQjtJQUVBLE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDNUQsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBRTFCLElBQUksR0FBRyxHQUFHLGdCQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFdEMsSUFBSSxHQUFHLGtCQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFdkIsTUFBTSxRQUFRO2FBQ1osT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3BDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBRXZDLElBQUksTUFBTSxHQUFHLGdCQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRTdCLElBQUksSUFBSSxHQUFHLGdCQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsRUFBRSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVsRCxJQUFJLElBQUksR0FBRyxnQkFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDL0IsSUFBSSxTQUFTLEdBQUcsZ0JBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRXJDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBRXZCLE9BQU8sUUFBUTtpQkFDYixPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQy9CLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7aUJBQ2hDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFFWCxlQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUVyRSxPQUFPLHFCQUFVLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1lBQ2xDLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBRVYsZUFBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFO29CQUN4QixHQUFHO29CQUNILElBQUksRUFBRSxHQUFHO29CQUNULElBQUk7aUJBQ0osQ0FBQyxDQUFBO1lBQ0gsQ0FBQyxDQUFDLENBQ0Q7UUFFSCxDQUFDLENBQUMsQ0FDRjtRQUVELE9BQU8scUJBQVUsQ0FBQyxnQkFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLEVBQUUsbUJBQVMsQ0FBQztZQUN4RCxNQUFNLEVBQUUsSUFBSTtTQUNaLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQ0Y7QUFDRixDQUFDO0FBbkRELGdDQW1EQztBQUVELFNBQWdCLElBQUksQ0FBQyxJQUFZLEVBQUUsUUFBZ0IsRUFBRTtJQUVwRCxPQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUMsbUJBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQTtBQUN4RSxDQUFDO0FBSEQsb0JBR0M7QUFFRCxTQUFnQixNQUFNLENBQUMsQ0FBa0I7SUFFeEMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUN0QyxDQUFDO0FBSEQsd0JBR0M7QUFFRCxTQUFnQixPQUFPLENBQUMsT0FFdkI7SUFFQSxPQUFPLFFBQVE7U0FDYixPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztTQUNyQixHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFFbEMsSUFBSSxNQUFNLEdBQUcsZ0JBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRW5DLElBQUksUUFBUSxHQUFHLGdCQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsSUFBSSxHQUFHLEdBQUcsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO1FBRXhHLGVBQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3hFLE1BQU0scUJBQVUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTNDLE9BQU8sUUFBUSxDQUFBO0lBQ2hCLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQWpCRCwwQkFpQkM7QUFFRCxTQUFnQixPQUFPLENBQUMsSUFBWTtJQUVuQyxPQUFPLHNCQUFNLENBQUMsSUFBSSxFQUFFO1FBQ25CLGtCQUFrQixFQUFFLElBQUk7UUFDeEIsa0JBQWtCLEVBQUUsSUFBSTtRQUN4QixvQkFBb0IsRUFBRSxJQUFJO1FBQzFCLGFBQWEsRUFBRSxJQUFJO0tBQ25CLENBQUMsQ0FBQztBQUNKLENBQUM7QUFSRCwwQkFRQztBQUVELFNBQWdCLFNBQVMsQ0FBQyxLQUFhO0lBRXRDLE9BQU8sc0JBQXNCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLFdBQVcsQ0FBQyxLQUFLLENBQUMsSUFBSSxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUE7QUFDdkYsQ0FBQztBQUhELDhCQUdDO0FBRUQsU0FBZ0IsWUFBWSxDQUFDLEtBQWEsRUFBRSxXQUFtQixDQUFDO0lBRS9ELElBQUksQ0FBQyxHQUFHLGtCQUFPLENBQUMsMkJBQTJCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFcEQsT0FBTyxDQUFDLENBQUMsTUFBTSxJQUFJLFFBQVEsQ0FBQztBQUM3QixDQUFDO0FBTEQsb0NBS0M7QUFFRCxTQUFnQixXQUFXLENBQUMsS0FBYSxFQUFFLFdBQW1CLENBQUM7SUFFOUQsSUFBSSxDQUFDLEdBQUcsa0JBQU8sQ0FBQyxtQkFBbUIsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUU1QyxPQUFPLENBQUMsQ0FBQyxNQUFNLElBQUksUUFBUSxDQUFDO0FBQzdCLENBQUM7QUFMRCxrQ0FLQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTkvNy8xMC5cbiAqL1xuXG5pbXBvcnQgSlNaaXAgPSByZXF1aXJlKCdqc3ppcCcpO1xuaW1wb3J0IEJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmltcG9ydCB7IG91dHB1dEZpbGUsIHJlYWRGaWxlLCB0cmltRmlsZW5hbWUgfSBmcm9tICdmcy1pY29udic7XG5pbXBvcnQgeyBCdWZmZXJGcm9tLCBkZWNvZGUsIEVOVU1fTk9ERV9FTkNPRElORyB9IGZyb20gJ2ljb252LWpzY2hhcmRldCc7XG5pbXBvcnQgbWljcm9tYXRjaCA9IHJlcXVpcmUoJ21pY3JvbWF0Y2gnKTtcbmltcG9ydCB7IEpTRE9NLCBjcmVhdGVKU0RPTSwgSUpTRE9NLCBhc3luY0pTRE9NIH0gZnJvbSAnanNkb20tZXh0cmEnO1xuaW1wb3J0IHsgbWluaWZ5IH0gZnJvbSAnaHRtbC1taW5pZmllcic7XG5pbXBvcnQgcGF0aCBmcm9tICd1cGF0aDInO1xuaW1wb3J0IHsgc3RyaW5naWZ5IH0gZnJvbSAnbWRjb25mMic7XG5pbXBvcnQgeyBDb25zb2xlIH0gZnJvbSAnZGVidWctY29sb3IyJztcbmltcG9ydCBleGVjYWxsIGZyb20gJ2V4ZWNhbGwyJztcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaCc7XG5cbmV4cG9ydCBjb25zdCBjb25zb2xlID0gbmV3IENvbnNvbGUobnVsbCwge1xuXHRlbmFibGVkOiB0cnVlLFxuXHRpbnNwZWN0T3B0aW9uczoge1xuXHRcdGNvbG9yczogdHJ1ZSxcblx0fSxcblx0Y2hhbGtPcHRpb25zOiB7XG5cdFx0ZW5hYmxlZDogdHJ1ZSxcblx0fSxcbn0pO1xuXG5jb25zb2xlLmVuYWJsZWRDb2xvciA9IHRydWU7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUltYWdlcyBleHRlbmRzIFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbntcblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDYWNoZVxue1xuXHRfYXR0YWNoPzogUmVjb3JkPHN0cmluZywge1xuXHRcdGltYWdlczogSUltYWdlcyxcblx0fT5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRmlsZVxue1xuXHRpbmRleDogbnVtYmVyO1xuXHRuYW1lOiBzdHJpbmc7XG5cdGlzRGlyOiBib29sZWFuO1xuXHR0aXRsZTogc3RyaW5nO1xuXHRpbm5lclRleHQ6IHN0cmluZztcblx0aW1nczogSUltYWdlcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJUmV0dXJuRGF0YVxue1xuXHR6aXA6IEpTWmlwO1xuXHR0eHRzOiBJRmlsZVtdO1xuXHRmaWxlczoge1xuXHRcdFtrZXk6IHN0cmluZ106IEpTWmlwLkpTWmlwT2JqZWN0O1xuXHR9O1xuXHRjYWNoZTogSUNhY2hlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXV0b0V4dHJhY3Qoc3JjRmlsZTogc3RyaW5nLCBzZXR0aW5nPzoge1xuXHRjd2Q/OiBzdHJpbmdcbn0pXG57XG5cdHJldHVybiBsb2FkKHNyY0ZpbGUpXG5cdFx0LnRhcChhc3luYyAoZGF0YSkgPT5cblx0XHR7XG5cdFx0XHRjb25zdCBjd2QgPSBzZXR0aW5nICYmIHNldHRpbmcuY3dkIHx8IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBmaXhGaWxlbmFtZShwYXRoLmJhc2VuYW1lKHNyY0ZpbGUpKSk7XG5cblx0XHRcdGxldCBvcHRpb25zID0ge1xuXHRcdFx0XHQuLi5kYXRhLFxuXHRcdFx0XHRjd2QsXG5cdFx0XHR9O1xuXG5cdFx0XHRjb25zb2xlLmRpcih7XG5cdFx0XHRcdHNyY0ZpbGUsXG5cdFx0XHRcdGN3ZCxcblx0XHRcdH0pO1xuXG5cdFx0XHRyZXR1cm4gQmx1ZWJpcmQuYWxsKFtcblx0XHRcdFx0c2F2ZVR4dChvcHRpb25zKSxcblx0XHRcdFx0c2F2ZUF0dGFjaChvcHRpb25zKVxuXHRcdFx0XSk7XG5cdFx0fSlcblx0XHQ7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGF1dG9FeHRyYWN0XG5cbmV4cG9ydCBmdW5jdGlvbiBmaXhGaWxlbmFtZShmaWxlOiBzdHJpbmcpXG57XG5cdHJldHVybiB0cmltRmlsZW5hbWUoZGVjb2RlVVJJQ29tcG9uZW50KGZpbGUpKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVmZmVyKGJ1ZjogQnVmZmVyLCBjYWNoZTogSUNhY2hlID0ge30pXG57XG5cdHJldHVybiBCbHVlYmlyZC5yZXNvbHZlKEpTWmlwLmxvYWRBc3luYyhidWYsIHtcblx0XHRcdGRlY29kZUZpbGVOYW1lKGJ5dGVzKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KGRlY29kZShieXRlcykpXG5cdFx0XHR9LFxuXHRcdH0pKVxuXHRcdC50aGVuPElSZXR1cm5EYXRhPihhc3luYyAoemlwKSA9PlxuXHRcdHtcblx0XHRcdGxldCB0eHRzID0gYXdhaXQgZmlsZXMoemlwLmZpbGUoL1xcLig/OnhodG1sfGh0bWw/KSQvKSwgY2FjaGUpO1xuXG5cdFx0XHRyZXR1cm4gQmx1ZWJpcmQucHJvcHMoe1xuXHRcdFx0XHR6aXAsXG5cdFx0XHRcdHR4dHMsXG5cdFx0XHRcdGZpbGVzOiB6aXAuZmlsZXMsXG5cdFx0XHRcdGNhY2hlLFxuXHRcdFx0fSlcblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbGVzKGZpbGVzOiBKU1ppcC5KU1ppcE9iamVjdFtdLCBjYWNoZTogSUNhY2hlID0ge30pXG57XG5cdGlmIChjYWNoZS5fYXR0YWNoID09IG51bGwpXG5cdHtcblx0XHRjYWNoZS5fYXR0YWNoID0ge307XG5cdH1cblxuXHRyZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZShmaWxlcylcblx0XHQubWFwKGFzeW5jIChmaWxlLCBpbmRleCkgPT4ge1xuXHRcdFx0bGV0IGJ1ZiA9IGF3YWl0IGZpbGUuYXN5bmMoXCJub2RlYnVmZmVyXCIpXG5cdFx0XHRcdC50aGVuKGRlY29kZSlcblx0XHRcdFx0LnRoZW4oYnVmID0+IHtcblxuXHRcdFx0XHRcdHRyeVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJldHVybiBmaXhIdG1sKGJ1Zi50b1N0cmluZygpKVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRjYXRjaCAoZSlcblx0XHRcdFx0XHR7XG5cblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRyZXR1cm4gYnVmO1xuXHRcdFx0XHR9KVxuXHRcdFx0O1xuXG5cdFx0XHRsZXQganNkb20gPSBhd2FpdCBhc3luY0pTRE9NKGJ1Zik7XG5cdFx0XHRsZXQgeyAkLCBkb2N1bWVudCB9ID0ganNkb207XG5cblx0XHRcdGxldCB0aXRsZTogc3RyaW5nID0gZG9jdW1lbnQudGl0bGU7XG5cblx0XHRcdGxldCBfcGFyc2UgPSBwYXRoLnBhcnNlKGZpbGUubmFtZSk7XG5cdFx0XHRsZXQgX2lkID0gZml4RmlsZW5hbWUoX3BhcnNlLm5hbWUpLnJlcGxhY2UoL1teXFx3X1xcLV0rL2csICcnKS5zbGljZSgwLCAyMCk7XG5cblx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdGNhY2hlLl9hdHRhY2hbX3BhcnNlLmRpcl0gPSBjYWNoZS5fYXR0YWNoW19wYXJzZS5kaXJdIHx8IHt9O1xuXG5cdFx0XHRjYWNoZS5fYXR0YWNoW19wYXJzZS5kaXJdLmltYWdlcyA9IGNhY2hlLl9hdHRhY2hbX3BhcnNlLmRpcl0uaW1hZ2VzIHx8IHt9O1xuXG5cdFx0XHRsZXQgaW1nczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG5cdFx0XHQkKCdpbWcnKS5lYWNoKChpLCBlbGVtKSA9PiB7XG5cblx0XHRcdFx0bGV0IF90aGlzID0gJChlbGVtKTtcblx0XHRcdFx0bGV0IHNyYyA9IChfdGhpcy5hdHRyKCdzcmMnKSB8fCAnJykudHJpbSgpO1xuXG5cdFx0XHRcdGlmIChzcmMpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRsZXQgX25hbWUgPSBfaWQgKyBpLnRvU3RyaW5nKCkucGFkU3RhcnQoMywgJzAnKTtcblxuXHRcdFx0XHRcdHdoaWxlIChjYWNoZS5fYXR0YWNoW19wYXJzZS5kaXJdLmltYWdlc1tfbmFtZV0gIT0gbnVsbClcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRfbmFtZSA9IF9pZCArICgrK2kpLnRvU3RyaW5nKCkucGFkU3RhcnQoMywgJzAnKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRzcmMgPSBkZWNvZGVVUklDb21wb25lbnQoc3JjKTtcblxuXHRcdFx0XHRcdGltZ3NbX25hbWVdID0gc3JjO1xuXHRcdFx0XHRcdGNhY2hlLl9hdHRhY2hbX3BhcnNlLmRpcl0uaW1hZ2VzW19uYW1lXSA9IHNyYztcblxuXHRcdFx0XHRcdF90aGlzLmFmdGVyKGBcXG4o5ZyW54mHJHtfbmFtZX0pXFxuYCk7XG5cdFx0XHRcdFx0X3RoaXMucmVtb3ZlKCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0fSk7XG5cblx0XHRcdGxldCBpbm5lclRleHQ6IHN0cmluZyA9ICQoZG9jdW1lbnQuYm9keSlcblx0XHRcdFx0LnRleHQoKVxuXHRcdFx0XHQucmVwbGFjZSgvXlxcbnsyLH18XFxuezIsfSQvZywgJ1xcbicpXG5cdFx0XHQ7XG5cblx0XHRcdHJldHVybiA8SUZpbGU+e1xuXHRcdFx0XHRpbmRleCxcblx0XHRcdFx0bmFtZTogZmlsZS5uYW1lLFxuXHRcdFx0XHRpc0RpcjogZmlsZS5kaXIsXG5cdFx0XHRcdHRpdGxlLFxuXHRcdFx0XHRpbm5lclRleHQsXG5cdFx0XHRcdGltZ3MsXG5cdFx0XHR9XG5cdFx0fSlcblx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2F2ZUF0dGFjaChvcHRpb25zOiBJUmV0dXJuRGF0YSAmIHtcblx0Y3dkOiBzdHJpbmcsXG59KVxue1xuXHRyZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZShPYmplY3QuZW50cmllcyhvcHRpb25zLmNhY2hlLl9hdHRhY2gpKVxuXHRcdC5tYXAoYXN5bmMgKFtkaXIsIGRhdGFdKSA9PlxuXHRcdHtcblx0XHRcdGxldCBjd2QgPSBwYXRoLmpvaW4ob3B0aW9ucy5jd2QsIGRpcik7XG5cblx0XHRcdGRhdGEgPSBjbG9uZURlZXAoZGF0YSk7XG5cblx0XHRcdGF3YWl0IEJsdWViaXJkXG5cdFx0XHRcdC5yZXNvbHZlKE9iamVjdC5lbnRyaWVzKGRhdGEuaW1hZ2VzKSlcblx0XHRcdFx0Lm1hcChhc3luYyAoW2lkLCBzcmNdLCBpbmRleCwgbGVuZ3RoKSA9PiB7XG5cblx0XHRcdFx0XHRsZXQgX3BhcnNlID0gcGF0aC5wYXJzZShzcmMpO1xuXG5cdFx0XHRcdFx0bGV0IF9zcmMgPSBwYXRoLmpvaW4oX3BhcnNlLmRpciwgaWQgKyBfcGFyc2UuZXh0KTtcblxuXHRcdFx0XHRcdGxldCBfaW1nID0gcGF0aC5qb2luKGRpciwgc3JjKTtcblx0XHRcdFx0XHRsZXQgX2ltZ19wYXRoID0gcGF0aC5qb2luKGN3ZCwgX3NyYyk7XG5cblx0XHRcdFx0XHRkYXRhLmltYWdlc1tpZF0gPSBfc3JjO1xuXG5cdFx0XHRcdFx0cmV0dXJuIEJsdWViaXJkXG5cdFx0XHRcdFx0XHQucmVzb2x2ZShvcHRpb25zLnppcC5maWxlKF9pbWcpKVxuXHRcdFx0XHRcdFx0LnRoZW4odiA9PiB2LmFzeW5jKCdub2RlYnVmZmVyJykpXG5cdFx0XHRcdFx0XHQudGhlbihidWYgPT5cblx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0Y29uc29sZS5ncmF5KGBbaW1nXVske3BhZE51bShpbmRleCl9LyR7cGFkTnVtKGxlbmd0aCl9XWAsIF9pbWdfcGF0aCk7XG5cblx0XHRcdFx0XHRcdFx0cmV0dXJuIG91dHB1dEZpbGUoX2ltZ19wYXRoLCBidWYpXG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdFx0LmNhdGNoKGUgPT5cblx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0Y29uc29sZS5lcnJvcihlLm1lc3NhZ2UsIHtcblx0XHRcdFx0XHRcdFx0XHRkaXIsXG5cdFx0XHRcdFx0XHRcdFx0bmFtZTogc3JjLFxuXHRcdFx0XHRcdFx0XHRcdF9pbWcsXG5cdFx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdFx0O1xuXG5cdFx0XHRcdH0pXG5cdFx0XHQ7XG5cblx0XHRcdHJldHVybiBvdXRwdXRGaWxlKHBhdGguam9pbihjd2QsICdBVFRBQ0gubWQnKSwgc3RyaW5naWZ5KHtcblx0XHRcdFx0YXR0YWNoOiBkYXRhLFxuXHRcdFx0fSkpXG5cdFx0fSlcblx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbG9hZChmaWxlOiBzdHJpbmcsIGNhY2hlOiBJQ2FjaGUgPSB7fSlcbntcblx0cmV0dXJuIEJsdWViaXJkLnJlc29sdmUocmVhZEZpbGUoZmlsZSkpLnRoZW4oYnVmID0+IGJ1ZmZlcihidWYsIGNhY2hlKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhZE51bShuOiBzdHJpbmcgfCBudW1iZXIpXG57XG5cdHJldHVybiBuLnRvU3RyaW5nKCkucGFkU3RhcnQoMywgJzAnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNhdmVUeHQob3B0aW9uczogSVJldHVybkRhdGEgJiB7XG5cdGN3ZDogc3RyaW5nLFxufSlcbntcblx0cmV0dXJuIEJsdWViaXJkXG5cdFx0LnJlc29sdmUob3B0aW9ucy50eHRzKVxuXHRcdC5tYXAoYXN5bmMgKGZpbGUsIGluZGV4LCBsZW5ndGgpID0+XG5cdFx0e1xuXHRcdFx0bGV0IF9wYXJzZSA9IHBhdGgucGFyc2UoZmlsZS5uYW1lKTtcblxuXHRcdFx0bGV0IGZpbGVuYW1lID0gcGF0aC5qb2luKG9wdGlvbnMuY3dkLCBfcGFyc2UuZGlyLCBfcGFyc2UubmFtZSArICdfJyArIGZpeEZpbGVuYW1lKGZpbGUudGl0bGUpICsgJy50eHQnKTtcblxuXHRcdFx0Y29uc29sZS5ncmF5LmxvZyhgW3R4dF1bJHtwYWROdW0oaW5kZXgpfS8ke3BhZE51bShsZW5ndGgpfV1gLCBmaWxlbmFtZSk7XG5cdFx0XHRhd2FpdCBvdXRwdXRGaWxlKGZpbGVuYW1lLCBmaWxlLmlubmVyVGV4dCk7XG5cblx0XHRcdHJldHVybiBmaWxlbmFtZVxuXHRcdH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaXhIdG1sKGh0bWw6IHN0cmluZyk6IHN0cmluZ1xue1xuXHRyZXR1cm4gbWluaWZ5KGh0bWwsIHtcblx0XHRjb2xsYXBzZVdoaXRlc3BhY2U6IHRydWUsXG5cdFx0cHJlc2VydmVMaW5lQnJlYWtzOiB0cnVlLFxuXHRcdGNvbnNlcnZhdGl2ZUNvbGxhcHNlOiB0cnVlLFxuXHRcdGNhc2VTZW5zaXRpdmU6IHRydWUsXG5cdH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNCYWROYW1lKGlucHV0OiBzdHJpbmcpXG57XG5cdHJldHVybiAvaW5kZXh8XmltZyR8XFxkezEwLH0vaS50ZXN0KGlucHV0KSB8fCBpc0VuY29kZVVSSShpbnB1dCkgfHwgaXNIYXNoZWRMaWtlKGlucHV0KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNIYXNoZWRMaWtlKGlucHV0OiBzdHJpbmcsIG1heENvdW50OiBudW1iZXIgPSAzKVxue1xuXHRsZXQgciA9IGV4ZWNhbGwoLyhbYS1mXVswLTldfFswLTldW2EtZl0pL2lnLCBpbnB1dCk7XG5cblx0cmV0dXJuIHIubGVuZ3RoID49IG1heENvdW50O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNFbmNvZGVVUkkoaW5wdXQ6IHN0cmluZywgbWF4Q291bnQ6IG51bWJlciA9IDMpXG57XG5cdGxldCByID0gZXhlY2FsbCgvKCVbMC05YS1mXXsyLH0pL2lnLCBpbnB1dCk7XG5cblx0cmV0dXJuIHIubGVuZ3RoID49IG1heENvdW50O1xufVxuIl19